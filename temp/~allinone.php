<?php if(!defined('THINK_PATH')) define('THINK_PATH','./core/ThinkPHP');if(!defined('RUNTIME_PATH')) define('RUNTIME_PATH','./temp/');if(!defined('APP_PATH')) define('APP_PATH','./core');if(!defined('APP_NAME')) define('APP_NAME','532movie');define('MAGIC_QUOTES_GPC',true);define('MEMORY_LIMIT_ON',true);define('IS_CGI',1);define('IS_WIN',0);define('IS_CLI',0);define('_PHP_FILE_','/532movie/index.php');define('__ROOT__','');define('URL_COMMON',0);define('URL_PATHINFO',1);define('URL_REWRITE',2);define('URL_COMPAT',3);define('THINK_VERSION','2.0');define('CACHE_DIR','Cache');define('HTML_DIR','Html');define('CONF_DIR','Conf');define('LIB_DIR','Lib');define('LOG_DIR','Logs');define('LANG_DIR','Lang');define('TEMP_DIR','Temp');define('TMPL_DIR','Tpl');define('TMPL_PATH','./template/');define('HTML_PATH','./temp/Html/');define('COMMON_PATH','./core/Common/');define('LIB_PATH','./core/Lib/');define('CACHE_PATH','./temp/Cache/');define('CONFIG_PATH','./core/Conf/');define('LOG_PATH','./temp/Logs/');define('LANG_PATH','./core/Lang/');define('TEMP_PATH','./temp/Temp/');define('DATA_PATH','./temp/Data/');define('VENDOR_PATH','./core/ThinkPHP/Vendor/');if(!defined('RUNTIME_ALLINONE')) define('RUNTIME_ALLINONE',true); if (!defined('THINK_PATH')) exit(); if(version_compare(PHP_VERSION,'6.0.0','<') ) { @set_magic_quotes_runtime (0); define('MAGIC_QUOTES_GPC',get_magic_quotes_gpc()?True:False); } define('MEMORY_LIMIT_ON',function_exists('memory_get_usage')); define('IS_CGI',substr(PHP_SAPI, 0,3)=='cgi' ? 1 : 0 ); define('IS_WIN',strstr(PHP_OS, 'WIN') ? 1 : 0 ); define('IS_CLI',PHP_SAPI=='cli'? 1 : 0); if(!IS_CLI) { if(!defined('_PHP_FILE_')) { if(IS_CGI) { $_temp = explode('.php',$_SERVER["PHP_SELF"]); define('_PHP_FILE_', rtrim(str_replace($_SERVER["HTTP_HOST"],'',$_temp[0].'.php'),'/')); }else { define('_PHP_FILE_', rtrim($_SERVER["SCRIPT_NAME"],'/')); } } if(!defined('__ROOT__')) { if( strtoupper(APP_NAME) == strtoupper(basename(dirname(_PHP_FILE_))) ) { $_root = dirname(dirname(_PHP_FILE_)); }else { $_root = dirname(_PHP_FILE_); } define('__ROOT__', (($_root=='/' || $_root=='\\')?'':$_root)); } define('URL_COMMON', 0); define('URL_PATHINFO', 1); define('URL_REWRITE', 2); define('URL_COMPAT', 3); } define('THINK_VERSION', '2.0'); if(MEMORY_LIMIT_ON) { $GLOBALS['_startUseMems'] = memory_get_usage(); } define('CACHE_DIR', 'Cache'); define('HTML_DIR', 'Html'); define('CONF_DIR', 'Conf'); define('LIB_DIR', 'Lib'); define('LOG_DIR', 'Logs'); define('LANG_DIR', 'Lang'); define('TEMP_DIR', 'Temp'); define('TMPL_DIR', 'Tpl'); define('TMPL_PATH','./template/'); define('HTML_PATH','./temp/'.HTML_DIR.'/'); define('COMMON_PATH', APP_PATH.'/Common/'); define('LIB_PATH', APP_PATH.'/'.LIB_DIR.'/'); define('CACHE_PATH', RUNTIME_PATH.CACHE_DIR.'/'); define('CONFIG_PATH', APP_PATH.'/'.CONF_DIR.'/'); define('LOG_PATH', RUNTIME_PATH.LOG_DIR.'/'); define('LANG_PATH', APP_PATH.'/'.LANG_DIR.'/'); define('TEMP_PATH', RUNTIME_PATH.TEMP_DIR.'/'); define('DATA_PATH', RUNTIME_PATH.'Data/'); define('VENDOR_PATH',THINK_PATH.'/Vendor/'); set_include_path(get_include_path() . PATH_SEPARATOR . VENDOR_PATH); function U($url,$params=array(),$redirect=false,$suffix=true) { if(0===strpos($url,'/')) $url = substr($url,1); if(!strpos($url,'://')) $url = APP_NAME.'://'.$url; if(stripos($url,'@?')) { $url = str_replace('@?','@think?',$url); }elseif(stripos($url,'@')) { $url = $url.MODULE_NAME; } $array = parse_url($url); $app = isset($array['scheme'])? $array['scheme'] :APP_NAME; $route = isset($array['user'])?$array['user']:''; if(defined('GROUP_NAME') && strcasecmp(GROUP_NAME,C('DEFAULT_GROUP'))) $group= GROUP_NAME; if(isset($array['path'])) { $action = substr($array['path'],1); if(!isset($array['host'])) { $module = MODULE_NAME; }else{ if(strpos($array['host'],'-')) { list($group,$module) = explode('-',$array['host']); }else{ $module = $array['host']; } } }else{ $module = MODULE_NAME; $action = $array['host']; } if(isset($array['query'])) { parse_str($array['query'],$query); $params = array_merge($query,$params); } if(C('URL_DISPATCH_ON') && C('URL_MODEL')>0) { $depr = C('URL_PATHINFO_MODEL')==2?C('URL_PATHINFO_DEPR'):'/'; $str = $depr; foreach ($params as $var=>$val) $str .= $var.$depr.$val.$depr; $str = substr($str,0,-1); $group = isset($group)?$group.$depr:''; if(!empty($route)) { $url = str_replace(APP_NAME,$app,__APP__).'/'.$group.$route.$str; }else{ $url = str_replace(APP_NAME,$app,__APP__).'/'.$group.$module.$depr.$action.$str; } if($suffix && C('URL_HTML_SUFFIX')) $url .= C('URL_HTML_SUFFIX'); }else{ $params = http_build_query($params); if(isset($group)) { $url = str_replace(APP_NAME,$app,__APP__).'?'.C('VAR_GROUP').'='.$group.'&'.C('VAR_MODULE').'='.$module.'&'.C('VAR_ACTION').'='.$action.'&'.$params; }else{ $url = str_replace(APP_NAME,$app,__APP__).'?'.C('VAR_MODULE').'='.$module.'&'.C('VAR_ACTION').'='.$action.'&'.$params; } } if($redirect) redirect($url); else return $url; } function parse_name($name,$type=0) { if($type) { return ucfirst(preg_replace("/_([a-zA-Z])/e", "strtoupper('\\1')", $name)); }else{ $name = preg_replace("/[A-Z]/", "_\\0", $name); return strtolower(trim($name, "_")); } } function halt($error) { if(IS_CLI) exit ($error); $e = array(); if(C('APP_DEBUG')){ if(!is_array($error)) { $trace = debug_backtrace(); $e['message'] = $error; $e['file'] = $trace[0]['file']; $e['class'] = $trace[0]['class']; $e['function'] = $trace[0]['function']; $e['line'] = $trace[0]['line']; $traceInfo=''; $time = date("y-m-d H:i:m"); foreach($trace as $t) { $traceInfo .= '['.$time.'] '.$t['file'].' ('.$t['line'].') '; $traceInfo .= $t['class'].$t['type'].$t['function'].'('; $traceInfo .= implode(', ', $t['args']); $traceInfo .=")<br/>"; } $e['trace'] = $traceInfo; }else { $e = $error; } include C('TMPL_EXCEPTION_FILE'); } else { $error_page = C('ERROR_PAGE'); if(!empty($error_page)){ redirect($error_page); }else { if(C('SHOW_ERROR_MSG')) $e['message'] = is_array($error)?$error['message']:$error; else $e['message'] = C('ERROR_MESSAGE'); include C('TMPL_EXCEPTION_FILE'); } } exit; } function redirect($url,$time=0,$msg='') { $url = str_replace(array("\n", "\r"), '', $url); if(empty($msg)) $msg = "系统将在{$time}秒之后自动跳转到{$url}！"; if (!headers_sent()) { if(0===$time) { header("Location: ".$url); }else { header("refresh:{$time};url={$url}"); echo($msg); } exit(); }else { $str = "<meta http-equiv='Refresh' content='{$time};URL={$url}'>"; if($time!=0) $str .= $msg; exit($str); } } function throw_exception($msg,$type='ThinkException',$code=0) { if(IS_CLI) exit($msg); if(class_exists($type,false)) throw new $type($msg,$code,true); else halt($msg); } function debug_start($label='') { $GLOBALS[$label]['_beginTime'] = microtime(TRUE); if ( MEMORY_LIMIT_ON ) $GLOBALS[$label]['_beginMem'] = memory_get_usage(); } function debug_end($label='') { $GLOBALS[$label]['_endTime'] = microtime(TRUE); echo '<div style="text-align:center;width:100%">Process '.$label.': Times '.number_format($GLOBALS[$label]['_endTime']-$GLOBALS[$label]['_beginTime'],6).'s '; if ( MEMORY_LIMIT_ON ) { $GLOBALS[$label]['_endMem'] = memory_get_usage(); echo ' Memories '.number_format(($GLOBALS[$label]['_endMem']-$GLOBALS[$label]['_beginMem'])/1024).' k'; } echo '</div>'; } function dump($var, $echo=true,$label=null, $strict=true) { $label = ($label===null) ? '' : rtrim($label) . ' '; if(!$strict) { if (ini_get('html_errors')) { $output = print_r($var, true); $output = "<pre>".$label.htmlspecialchars($output,ENT_QUOTES)."</pre>"; } else { $output = $label . " : " . print_r($var, true); } }else { ob_start(); var_dump($var); $output = ob_get_clean(); if(!extension_loaded('xdebug')) { $output = preg_replace("/\]\=\>\n(\s+)/m", "] => ", $output); $output = '<pre>'. $label. htmlspecialchars($output, ENT_QUOTES). '</pre>'; } } if ($echo) { echo($output); return null; }else return $output; } function get_instance_of($name,$method='',$args=array()) { static $_instance = array(); $identify = empty($args)?$name.$method:$name.$method.to_guid_string($args); if (!isset($_instance[$identify])) { if(class_exists($name)){ $o = new $name(); if(method_exists($o,$method)){ if(!empty($args)) { $_instance[$identify] = call_user_func_array(array(&$o, $method), $args); }else { $_instance[$identify] = $o->$method(); } } else $_instance[$identify] = $o; } else halt(L('_CLASS_NOT_EXIST_').':'.$name); } return $_instance[$identify]; } function __autoload($name) { if(alias_import($name)) return ; if(substr($name,-5)=="Model") { require_cache(LIB_PATH.'Model/'.$name.'.class.php'); }elseif(substr($name,-6)=="Action"){ require_cache(LIB_PATH.'Action/'.$name.'.class.php'); }else { if(C('APP_AUTOLOAD_PATH')) { $paths = explode(',',C('APP_AUTOLOAD_PATH')); foreach ($paths as $path){ if(import($path.$name)) { return ; } } } } return ; } function require_cache($filename) { static $_importFiles = array(); $filename = realpath($filename); if (!isset($_importFiles[$filename])) { if(file_exists_case($filename)){ require $filename; $_importFiles[$filename] = true; } else { $_importFiles[$filename] = false; } } return $_importFiles[$filename]; } function file_exists_case($filename) { if(is_file($filename)) { if(IS_WIN && C('APP_FILE_CASE')) { if(basename(realpath($filename)) != basename($filename)) return false; } return true; } return false; } function import($class,$baseUrl = '',$ext='.class.php') { static $_file = array(); static $_class = array(); $class = str_replace(array('.','#'), array('/','.'), $class); if('' === $baseUrl && false === strpos($class,'/')) { return alias_import($class); } if(isset($_file[$class.$baseUrl])) return true; else $_file[$class.$baseUrl] = true; $class_strut = explode("/",$class); if(empty($baseUrl)) { if('@'==$class_strut[0] || APP_NAME == $class_strut[0] ) { $baseUrl = dirname(LIB_PATH); $class = str_replace(array(APP_NAME.'/','@/'),LIB_DIR.'/',$class); }elseif(in_array(strtolower($class_strut[0]),array('think','org','com'))) { $baseUrl = THINK_PATH.'/Lib/'; }else { $class = substr_replace($class, '', 0,strlen($class_strut[0])+1); $baseUrl = APP_PATH.'/../'.$class_strut[0].'/'.LIB_DIR.'/'; } } if(substr($baseUrl, -1) != "/") $baseUrl .= "/"; $classfile = $baseUrl . $class . $ext; if($ext == '.class.php' && is_file($classfile)) { $class = basename($classfile,$ext); if(isset($_class[$class])) throw_exception(L('_CLASS_CONFLICT_').':'.$_class[$class].' '.$classfile); $_class[$class] = $classfile; } return require_cache($classfile); } function load($name,$baseUrl='',$ext='.php') { $name = str_replace(array('.','#'), array('/','.'), $name); if(empty($baseUrl)) { if(0 === strpos($name,'@/')) { $baseUrl = APP_PATH.'/Common/'; $name = substr($name,2); }else{ $baseUrl = THINK_PATH.'/Common/'; } } if(substr($baseUrl, -1) != "/") $baseUrl .= "/"; include $baseUrl . $name . $ext; } function vendor($class,$baseUrl = '',$ext='.php') { if(empty($baseUrl)) $baseUrl = VENDOR_PATH; return import($class,$baseUrl,$ext); } function alias_import($alias,$classfile='') { static $_alias = array(); if('' !== $classfile) { $_alias[$alias] = $classfile; return ; } if(is_string($alias)) { if(isset($_alias[$alias])) return require_cache($_alias[$alias]); }elseif(is_array($alias)){ foreach ($alias as $key=>$val) $_alias[$key] = $val; return ; } return false; } function D($name='',$app='') { static $_model = array(); if(empty($name)) return new Model; if(empty($app)) $app = C('DEFAULT_APP'); if(isset($_model[$app.$name])) return $_model[$app.$name]; $OriClassName = $name; if(strpos($name,C('APP_GROUP_DEPR'))) { $array = explode(C('APP_GROUP_DEPR'),$name); $name = array_pop($array); $className = $name.'Model'; import($app.'.Model.'.implode('.',$array).'.'.$className); }else{ $className = $name.'Model'; import($app.'.Model.'.$className); } if(class_exists($className)) { $model = new $className(); }else { $model = new Model($name); } $_model[$app.$OriClassName] = $model; return $model; } function M($name='',$class='Model') { static $_model = array(); if(!isset($_model[$name.'_'.$class])) $_model[$name.'_'.$class] = new $class($name); return $_model[$name.'_'.$class]; } function A($name,$app='@') { static $_action = array(); if(isset($_action[$app.$name])) return $_action[$app.$name]; $OriClassName = $name; if(strpos($name,C('APP_GROUP_DEPR'))) { $array = explode(C('APP_GROUP_DEPR'),$name); $name = array_pop($array); $className = $name.'Action'; import($app.'.Action.'.implode('.',$array).'.'.$className); }else{ $className = $name.'Action'; import($app.'.Action.'.$className); } if(class_exists($className)) { $action = new $className(); $_action[$app.$OriClassName] = $action; return $action; }else { return false; } } function R($module,$action,$app='@') { $class = A($module,$app); if($class) return call_user_func(array(&$class,$action)); else return false; } function L($name=null,$value=null) { static $_lang = array(); if(empty($name)) return $_lang; if (is_string($name) ) { $name = strtoupper($name); if (is_null($value)) return isset($_lang[$name]) ? $_lang[$name] : $name; $_lang[$name] = $value; return; } if (is_array($name)) $_lang = array_merge($_lang,array_change_key_case($name,CASE_UPPER)); return; } function C($name=null,$value=null) { static $_config = array(); if(empty($name)) return $_config; if (is_string($name)) { if (!strpos($name,'.')) { $name = strtolower($name); if (is_null($value)) return isset($_config[$name])? $_config[$name] : null; $_config[$name] = $value; return; } $name = explode('.',$name); $name[0] = strtolower($name[0]); if (is_null($value)) return isset($_config[$name[0]][$name[1]]) ? $_config[$name[0]][$name[1]] : null; $_config[$name[0]][$name[1]] = $value; return; } if(is_array($name)) return $_config = array_merge($_config,array_change_key_case($name)); return null; } function tag($name,$params=array()) { $tags = C('_tags_.'.$name); if($tags) { foreach ($tags as $key=>$call){ if(is_callable($call)) $result = call_user_func_array($call,$params); } return $result; } return false; } function B($name) { $class = $name.'Behavior'; require_cache(LIB_PATH.'Behavior/'.$class.'.class.php'); $behavior = new $class(); $behavior->run(); } function W($name,$data=array(),$return=false) { $class = $name.'Widget'; require_cache(LIB_PATH.'Widget/'.$class.'.class.php'); if(!class_exists($class)) throw_exception(L('_CLASS_NOT_EXIST_').':'.$class); $widget = Think::instance($class); $content = $widget->render($data); if($return) return $content; else echo $content; } function S($name,$value='',$expire='',$type='') { static $_cache = array(); alias_import('Cache'); $cache = Cache::getInstance($type); if('' !== $value) { if(is_null($value)) { $result = $cache->rm($name); if($result) unset($_cache[$type.'_'.$name]); return $result; }else{ $cache->set($name,$value,$expire); $_cache[$type.'_'.$name] = $value; } return ; } if(isset($_cache[$type.'_'.$name])) return $_cache[$type.'_'.$name]; $value = $cache->get($name); $_cache[$type.'_'.$name] = $value; return $value; } function F($name,$value='',$path=DATA_PATH) { static $_cache = array(); $filename = $path.$name.'.php'; if('' !== $value) { if(is_null($value)) { return unlink($filename); }else{ $dir = dirname($filename); if(!is_dir($dir)) mkdir($dir); return file_put_contents($filename,"<?php\nreturn ".var_export($value,true).";\n?>"); } } if(isset($_cache[$name])) return $_cache[$name]; if(is_file($filename)) { $value = include $filename; $_cache[$name] = $value; }else{ $value = false; } return $value; } function to_guid_string($mix) { if(is_object($mix) && function_exists('spl_object_hash')) { return spl_object_hash($mix); }elseif(is_resource($mix)){ $mix = get_resource_type($mix).strval($mix); }else{ $mix = serialize($mix); } return md5($mix); } function compile($filename,$runtime=false) { $content = file_get_contents($filename); if(true === $runtime) $content = preg_replace('/\/\/\[RUNTIME\](.*?)\/\/\[\/RUNTIME\]/s','',$content); $content = substr(trim($content),5); if('?>' == substr($content,-2)) $content = substr($content,0,-2); return $content; } function strip_whitespace($content) { $stripStr = ''; $tokens = token_get_all ($content); $last_space = false; for ($i = 0, $j = count ($tokens); $i < $j; $i++) { if (is_string ($tokens[$i])) { $last_space = false; $stripStr .= $tokens[$i]; } else { switch ($tokens[$i][0]) { case T_COMMENT: case T_DOC_COMMENT: break; case T_WHITESPACE: if (!$last_space) { $stripStr .= ' '; $last_space = true; } break; default: $last_space = false; $stripStr .= $tokens[$i][1]; } } } return $stripStr; } function array_define($array) { $content = ''; foreach($array as $key=>$val) { $key = strtoupper($key); if(in_array($key,array('THINK_PATH','APP_NAME','APP_PATH','RUNTIME_PATH','RUNTIME_ALLINONE','THINK_MODE'))) $content .= 'if(!defined(\''.$key.'\')) '; if(is_int($val) || is_float($val)) { $content .= "define('".$key."',".$val.");"; }elseif(is_bool($val)) { $val = ($val)?'true':'false'; $content .= "define('".$key."',".$val.");"; }elseif(is_string($val)) { $content .= "define('".$key."','".addslashes($val)."');"; } } return $content; } function mk_dir($dir, $mode = 0755) { if (is_dir($dir) || @mkdir($dir,$mode)) return true; if (!mk_dir(dirname($dir),$mode)) return false; return @mkdir($dir,$mode); } function auto_charset($fContents,$from,$to){ $from = strtoupper($from)=='UTF8'? 'utf-8':$from; $to = strtoupper($to)=='UTF8'? 'utf-8':$to; if( strtoupper($from) === strtoupper($to) || empty($fContents) || (is_scalar($fContents) && !is_string($fContents)) ){ return $fContents; } if(is_string($fContents) ) { if(function_exists('mb_convert_encoding')){ return mb_convert_encoding ($fContents, $to, $from); }elseif(function_exists('iconv')){ return iconv($from,$to,$fContents); }else{ return $fContents; } } elseif(is_array($fContents)){ foreach ( $fContents as $key => $val ) { $_key = auto_charset($key,$from,$to); $fContents[$_key] = auto_charset($val,$from,$to); if($key != $_key ) unset($fContents[$key]); } return $fContents; } else{ return $fContents; } } function xml_encode($data,$encoding='utf-8',$root="think") { $xml = '<?xml version="1.0" encoding="'.$encoding.'"?>'; $xml.= '<'.$root.'>'; $xml.= data_to_xml($data); $xml.= '</'.$root.'>'; return $xml; } function data_to_xml($data) { if(is_object($data)) { $data = get_object_vars($data); } $xml = ''; foreach($data as $key=>$val) { is_numeric($key) && $key="item id=\"$key\""; $xml.="<$key>"; $xml.=(is_array($val)||is_object($val))?data_to_xml($val):$val; list($key,)=explode(' ',$key); $xml.="</$key>"; } return $xml; } function cookie($name,$value='',$option=null) { $config = array( 'prefix' => C('COOKIE_PREFIX'), 'expire' => C('COOKIE_EXPIRE'), 'path' => C('COOKIE_PATH'), 'domain' => C('COOKIE_DOMAIN'), ); if (!empty($option)) { if (is_numeric($option)) $option = array('expire'=>$option); elseif( is_string($option) ) parse_str($option,$option); array_merge($config,array_change_key_case($option)); } if (is_null($name)) { if (empty($_COOKIE)) return; $prefix = empty($value)? $config['prefix'] : $value; if (!empty($prefix)) { foreach($_COOKIE as $key=>$val) { if (0 === stripos($key,$prefix)){ setcookie($_COOKIE[$key],'',time()-3600,$config['path'],$config['domain']); unset($_COOKIE[$key]); } } } return; } $name = $config['prefix'].$name; if (''===$value){ return isset($_COOKIE[$name]) ? unserialize($_COOKIE[$name]) : null; }else { if (is_null($value)) { setcookie($name,'',time()-3600,$config['path'],$config['domain']); unset($_COOKIE[$name]); }else { $expire = !empty($config['expire'])? time()+ intval($config['expire']):0; setcookie($name,serialize($value),$expire,$config['path'],$config['domain']); $_COOKIE[$name] = serialize($value); } } } class Think { private static $_instance = array(); public function __set($name ,$value) { if(property_exists($this,$name)) $this->$name = $value; } public function __get($name) { return isset($this->$name)?$this->$name:null; } public static function autoload($classname) { if(alias_import($classname)) return ; if(substr($classname,-5)=="Model") { require_cache(LIB_PATH.'Model/'.$classname.'.class.php'); }elseif(substr($classname,-6)=="Action"){ require_cache(LIB_PATH.'Action/'.$classname.'.class.php'); }else { if(C('APP_AUTOLOAD_PATH')) { $paths = explode(',',C('APP_AUTOLOAD_PATH')); foreach ($paths as $path){ if(import($path.$classname)) return ; } } } return ; } static public function instance($class,$method='') { $identify = $class.$method; if(!isset(self::$_instance[$identify])) { if(class_exists($class)){ $o = new $class(); if(!empty($method) && method_exists($o,$method)) self::$_instance[$identify] = call_user_func_array(array(&$o, $method)); else self::$_instance[$identify] = $o; } else halt(L('_CLASS_NOT_EXIST_')); } return self::$_instance[$identify]; } } class ThinkException extends Exception { private $type; private $extra; public function __construct($message,$code=0,$extra=false) { parent::__construct($message,$code); $this->type = get_class($this); $this->extra = $extra; } public function __toString() { $trace = $this->getTrace(); if($this->extra) array_shift($trace); $this->class = $trace[0]['class']; $this->function = $trace[0]['function']; $this->file = $trace[0]['file']; $this->line = $trace[0]['line']; $file = file($this->file); $traceInfo=''; $time = date("y-m-d H:i:m"); foreach($trace as $t) { $traceInfo .= '['.$time.'] '.$t['file'].' ('.$t['line'].') '; $traceInfo .= $t['class'].$t['type'].$t['function'].'('; $traceInfo .= implode(', ', $t['args']); $traceInfo .=")\n"; } $error['message'] = $this->message; $error['type'] = $this->type; $error['detail'] = L('_MODULE_').'['.MODULE_NAME.'] '.L('_ACTION_').'['.ACTION_NAME.']'."\n"; $error['detail'] .= ($this->line-2).': '.$file[$this->line-3]; $error['detail'] .= ($this->line-1).': '.$file[$this->line-2]; $error['detail'] .= '<font color="#FF6600" >'.($this->line).': <b>'.$file[$this->line-1].'</b></font>'; $error['detail'] .= ($this->line+1).': '.$file[$this->line]; $error['detail'] .= ($this->line+2).': '.$file[$this->line+1]; $error['class'] = $this->class; $error['function'] = $this->function; $error['file'] = $this->file; $error['line'] = $this->line; $error['trace'] = $traceInfo; Log::Write('('.$this->type.') '.$this->message); return $error ; } } class Log extends Think { const EMERG = 'EMERG'; const ALERT = 'ALERT'; const CRIT = 'CRIT'; const ERR = 'ERR'; const WARN = 'WARN'; const NOTICE = 'NOTIC'; const INFO = 'INFO'; const DEBUG = 'DEBUG'; const SQL = 'SQL'; const SYSTEM = 0; const MAIL = 1; const TCP = 2; const FILE = 3; static $log = array(); static $format = '[ c ]'; static function record($message,$level=self::ERR,$record=false) { if($record || in_array($level,C('LOG_RECORD_LEVEL'))) { $now = date(self::$format); self::$log[] = "{$now} {$level}: {$message}\r\n"; } } static function save($type=self::FILE,$destination='',$extra='') { if(empty($destination)) $destination = LOG_PATH.date('y_m_d').".log"; if(self::FILE == $type) { if(is_file($destination) && floor(C('LOG_FILE_SIZE')) <= filesize($destination) ) rename($destination,dirname($destination).'/'.time().'-'.basename($destination)); } error_log(implode("",self::$log), $type,$destination ,$extra); self::$log = array(); } static function write($message,$level=self::ERR,$type=self::FILE,$destination='',$extra='') { $now = date(self::$format); if(empty($destination)) $destination = LOG_PATH.date('y_m_d').".log"; if(self::FILE == $type) { if(is_file($destination) && floor(C('LOG_FILE_SIZE')) <= filesize($destination) ) rename($destination,dirname($destination).'/'.time().'-'.basename($destination)); } error_log("{$now} {$level}: {$message}\r\n", $type,$destination,$extra ); } } class App { static public function init() { set_error_handler(array('App','appError')); set_exception_handler(array('App','appException')); if(defined('RUNTIME_MODEL')){ }elseif(is_file(RUNTIME_PATH.'~app.php') && (!is_file(CONFIG_PATH.'config.php') || filemtime(RUNTIME_PATH.'~app.php')>filemtime(CONFIG_PATH.'config.php'))) { C(include RUNTIME_PATH.'~app.php'); }else{ App::build(); } if(C('APP_PLUGIN_ON')) tag('app_begin'); if(function_exists('date_default_timezone_set')) date_default_timezone_set(C('DEFAULT_TIMEZONE')); if(C('APP_AUTOLOAD_REG') && function_exists('spl_autoload_register')) spl_autoload_register(array('Think', 'autoload')); if(C('SESSION_AUTO_START')) session_start(); if(C('URL_DISPATCH_ON')) Dispatcher::dispatch(); if(!defined('PHP_FILE')) define('PHP_FILE',_PHP_FILE_); if(C('APP_GROUP_LIST')) { if(!defined('GROUP_NAME')) define('GROUP_NAME', App::getGroup()); if(is_file(CONFIG_PATH.GROUP_NAME.'/config.php')) C(include CONFIG_PATH.GROUP_NAME.'/config.php'); if(is_file(COMMON_PATH.GROUP_NAME.'/function.php')) include COMMON_PATH.GROUP_NAME.'/function.php'; } if(!defined('MODULE_NAME')) define('MODULE_NAME', App::getModule()); if(!defined('ACTION_NAME')) define('ACTION_NAME', App::getAction()); if(is_file(CONFIG_PATH.strtolower(MODULE_NAME).'_config.php')) C(include CONFIG_PATH.strtolower(MODULE_NAME).'_config.php'); App::checkLanguage(); App::checkTemplate(); if(C('HTML_CACHE_ON')) HtmlCache::readHTMLCache(); if(C('APP_PLUGIN_ON')) tag('app_init'); return ; } static private function build() { C(include THINK_PATH.'/Common/convention.php'); if(is_file(CONFIG_PATH.'config.php')) C(include CONFIG_PATH.'config.php'); $runtime = defined('RUNTIME_ALLINONE'); $common = ''; $debug = C('APP_DEBUG') && !$runtime; if(is_file(COMMON_PATH.'common.php')) { include COMMON_PATH.'common.php'; if(!$debug) $common .= compile(COMMON_PATH.'common.php',$runtime); } if(is_file(CONFIG_PATH.'app.php')) { $list = include CONFIG_PATH.'app.php'; foreach ($list as $file){ require $file; if(!$debug) $common .= compile($file,$runtime); } } $list = C('APP_CONFIG_LIST'); foreach ($list as $val){ if(is_file(CONFIG_PATH.$val.'.php')) C('_'.$val.'_',array_change_key_case(include CONFIG_PATH.$val.'.php')); } if($debug) { C(include THINK_PATH.'/Common/debug.php'); if(is_file(CONFIG_PATH.'debug.php')) C(include CONFIG_PATH.'debug.php'); }else{ if(defined('RUNTIME_ALLINONE')) { $defs = get_defined_constants(TRUE); $content = array_define($defs['user']); $content .= substr(file_get_contents(RUNTIME_PATH.'~runtime.php'),5); $content .= $common."\nreturn ".var_export(C(),true).';'; file_put_contents(RUNTIME_PATH.'~allinone.php',strip_whitespace('<?php '.$content)); }else{ $content = "<?php ".$common."\nreturn ".var_export(C(),true).";\n?>"; file_put_contents(RUNTIME_PATH.'~app.php',strip_whitespace($content)); } } return ; } static private function getModule() { $var = C('VAR_MODULE'); $module = !empty($_POST[$var]) ? $_POST[$var] : (!empty($_GET[$var])? $_GET[$var]:C('DEFAULT_MODULE')); if(C('URL_CASE_INSENSITIVE')) { define('P_MODULE_NAME',strtolower($module)); $module = ucfirst(parse_name(P_MODULE_NAME,1)); } unset($_POST[$var],$_GET[$var]); return $module; } static private function getAction() { $var = C('VAR_ACTION'); $action = !empty($_POST[$var]) ? $_POST[$var] : (!empty($_GET[$var])?$_GET[$var]:C('DEFAULT_ACTION')); unset($_POST[$var],$_GET[$var]); return $action; } static private function getGroup() { $var = C('VAR_GROUP'); $group = !empty($_POST[$var]) ? $_POST[$var] : (!empty($_GET[$var])?$_GET[$var]:C('DEFAULT_GROUP')); unset($_POST[$var],$_GET[$var]); return ucfirst(strtolower($group)); } static private function checkLanguage() { $langSet = C('DEFAULT_LANG'); if (!C('LANG_SWITCH_ON')){ L(include THINK_PATH.'/Lang/'.$langSet.'.php'); return; } if (C('LANG_AUTO_DETECT')){ if(isset($_GET[C('VAR_LANGUAGE')])){ $langSet = $_GET[C('VAR_LANGUAGE')]; cookie('think_language',$langSet,3600); }elseif(cookie('think_language')) $langSet = cookie('think_language'); elseif(isset($_SERVER['HTTP_ACCEPT_LANGUAGE'])){ preg_match('/^([a-z\-]+)/i', $_SERVER['HTTP_ACCEPT_LANGUAGE'], $matches); $langSet = $matches[1]; cookie('think_language',$langSet,3600); } } define('LANG_SET',strtolower($langSet)); if(is_file(THINK_PATH.'/Lang/'.$langSet.'.php')) L(include THINK_PATH.'/Lang/'.$langSet.'.php'); if (is_file(LANG_PATH.$langSet.'/common.php')) L(include LANG_PATH.$langSet.'/common.php'); $group = ''; if (defined('GROUP_NAME')){ $group = GROUP_NAME.C('TMPL_FILE_DEPR'); if (is_file(LANG_PATH.$langSet.'/'.$group.'lang.php')) L(include LANG_PATH.$langSet.'/'.$group.'lang.php'); } if (is_file(LANG_PATH.$langSet.'/'.$group.strtolower(MODULE_NAME).'.php')) L(include LANG_PATH.$langSet.'/'.$group.strtolower(MODULE_NAME).'.php'); } static private function checkTemplate() { if(C('TMPL_DETECT_THEME')) { $t = C('VAR_TEMPLATE'); if (isset($_GET[$t])){ $templateSet = $_GET[$t]; cookie('think_template',$templateSet,3600); }else{ if(cookie('think_template')){ $templateSet = cookie('think_template'); }else{ $templateSet = C('DEFAULT_THEME'); cookie('think_template',$templateSet,3600); } } if(!is_dir(TMPL_PATH.$templateSet)) $templateSet = C('DEFAULT_THEME'); }else{ $templateSet = C('DEFAULT_THEME'); } define('TEMPLATE_NAME',$templateSet); define('TEMPLATE_PATH',TMPL_PATH.TEMPLATE_NAME); $tmplDir = TMPL_DIR.'/'.TEMPLATE_NAME.'/'; define('__APP__',PHP_FILE); define('__SELF__',$_SERVER['PHP_SELF']); if(C('APP_DOMAIN_DEPLOY')) { $appRoot = '/'; }else{ $appRoot = __ROOT__.'/'.APP_NAME.'/'; } $depr = C('URL_PATHINFO_MODEL')==2?C('URL_PATHINFO_DEPR'):'/'; $module = defined('P_MODULE_NAME')?P_MODULE_NAME:MODULE_NAME; if(defined('GROUP_NAME')) { $group = C('URL_CASE_INSENSITIVE') ?strtolower(GROUP_NAME):GROUP_NAME; define('__URL__',PHP_FILE.'/'.((GROUP_NAME != C('DEFAULT_GROUP'))?$group.$depr:'').$module); C('TMPL_FILE_NAME',TEMPLATE_PATH.'/'.GROUP_NAME.'/'.MODULE_NAME.C('TMPL_FILE_DEPR').ACTION_NAME.C('TMPL_TEMPLATE_SUFFIX')); C('CACHE_PATH',CACHE_PATH.GROUP_NAME.'/'); }else{ define('__URL__',PHP_FILE.'/'.$module); C('TMPL_FILE_NAME',TEMPLATE_PATH.'/'.str_replace(C('APP_GROUP_DEPR'),'/',MODULE_NAME).'/'.ACTION_NAME.C('TMPL_TEMPLATE_SUFFIX')); C('CACHE_PATH',CACHE_PATH); } define('__ACTION__',__URL__.C('URL_PATHINFO_DEPR').ACTION_NAME); define('__CURRENT__', __ROOT__.'/'.APP_NAME.'/'.$tmplDir.MODULE_NAME); define('APP_TMPL_PATH', $appRoot.$tmplDir); define('WEB_PUBLIC_PATH', __ROOT__.'/Public'); define('APP_PUBLIC_PATH', APP_TMPL_PATH.'Public'); return ; } static public function exec() { $tagOn = C('APP_PLUGIN_ON'); if($tagOn) tag('app_run'); $group = defined('GROUP_NAME') ? GROUP_NAME.C('APP_GROUP_DEPR') : ''; $module = A($group.MODULE_NAME); if(!$module) { $_module = C('_modules_.'.MODULE_NAME); if($_module) { import($_module[0]); $class = isset($_module[1])?$_module[1]:MODULE_NAME.'Action'; $module = new $class; }else{ $module = A("Empty"); } if(!$module) throw_exception(L('_MODULE_NOT_EXIST_').MODULE_NAME); } $action = ACTION_NAME; if(strpos($action,':')) { $actionList = explode(':',$action); foreach ($actionList as $action){ $module->$action(); } }else{ if (method_exists($module,'_before_'.$action)) { call_user_func(array(&$module,'_before_'.$action)); } call_user_func(array(&$module,$action)); if (method_exists($module,'_after_'.$action)) { call_user_func(array(&$module,'_after_'.$action)); } } if($tagOn) tag('app_end'); return ; } static public function run() { App::init(); if(C('SHOW_RUN_TIME')) $GLOBALS['_initTime'] = microtime(TRUE); App::exec(); if(C('LOG_RECORD')) Log::save(); return ; } static public function appException($e) { halt($e->__toString()); } static public function appError($errno, $errstr, $errfile, $errline) { switch ($errno) { case E_ERROR: case E_USER_ERROR: $errorStr = "[$errno] $errstr ".basename($errfile)." 第 $errline 行."; if(C('LOG_RECORD')) Log::write($errorStr,Log::ERR); halt($errorStr); break; case E_STRICT: case E_USER_WARNING: case E_USER_NOTICE: default: $errorStr = "[$errno] $errstr ".basename($errfile)." 第 $errline 行."; Log::record($errorStr,Log::NOTICE); break; } } }; abstract class Action extends Think { protected $view = null; private $name = ''; public function __construct() { $this->view = Think::instance('View'); if(method_exists($this,'_initialize')) $this->_initialize(); } protected function getActionName() { if(empty($this->name)) { $this->name = substr(get_class($this),0,-6); } return $this->name; } protected function isAjax() { if(isset($_SERVER['HTTP_X_REQUESTED_WITH']) ) { if('xmlhttprequest' == strtolower($_SERVER['HTTP_X_REQUESTED_WITH'])) return true; } if(!empty($_POST[C('VAR_AJAX_SUBMIT')]) || !empty($_GET[C('VAR_AJAX_SUBMIT')])) return true; return false; } protected function display($templateFile='',$charset='',$contentType='text/html') { $this->view->display($templateFile,$charset,$contentType); } protected function fetch($templateFile='',$charset='',$contentType='text/html') { return $this->view->fetch($templateFile,$charset,$contentType); } protected function buildHtml($htmlfile='',$htmlpath='',$templateFile='',$charset='',$contentType='text/html') { return $this->view->buildHtml($htmlfile,$htmlpath,$templateFile,$charset,$contentType); } protected function assign($name,$value='') { $this->view->assign($name,$value); } public function __set($name,$value) { $this->view->assign($name,$value); } protected function get($name) { return $this->view->get($name); } protected function trace($name,$value='') { $this->view->trace($name,$value); } public function __call($method,$parms) { if( 0 === strcasecmp($method,ACTION_NAME)) { $_action = C('_actions_'); if($_action) { if(isset($_action[MODULE_NAME.':'.ACTION_NAME])) { $action = $_action[MODULE_NAME.':'.ACTION_NAME]; }elseif(isset($_action[ACTION_NAME])){ $action = $_action[ACTION_NAME]; } if(!empty($action)) { call_user_func($action); return ; } } if(method_exists($this,'_empty')) { $this->_empty($method,$parms); }else { if(file_exists_case(C('TMPL_FILE_NAME'))) $this->display(); else throw_exception(L('_ERROR_ACTION_').ACTION_NAME); } }elseif(in_array(strtolower($method),array('ispost','isget','ishead','isdelete','isput'))){ return strtolower($_SERVER['REQUEST_METHOD']) == strtolower(substr($method,2)); }else{ throw_exception(__CLASS__.':'.$method.L('_METHOD_NOT_EXIST_')); } } protected function error($message,$ajax=false) { $this->_dispatch_jump($message,0,$ajax); } protected function success($message,$ajax=false) { $this->_dispatch_jump($message,1,$ajax); } protected function ajaxReturn($data,$info='',$status=1,$type='') { if(C('LOG_RECORD')) Log::save(); $result = array(); $result['status'] = $status; $result['info'] = $info; $result['data'] = $data; if(empty($type)) $type = C('DEFAULT_AJAX_RETURN'); if(strtoupper($type)=='JSON') { header("Content-Type:text/html; charset=utf-8"); exit(json_encode($result)); }elseif(strtoupper($type)=='XML'){ header("Content-Type:text/xml; charset=utf-8"); exit(xml_encode($result)); }elseif(strtoupper($type)=='EVAL'){ header("Content-Type:text/html; charset=utf-8"); exit($data); }else{ } } protected function redirect($url,$params=array(),$delay=0,$msg='') { if(C('LOG_RECORD')) Log::save(); $url = U($url,$params); redirect($url,$delay,$msg); } private function _dispatch_jump($message,$status=1,$ajax=false) { if($ajax || $this->isAjax()) $this->ajaxReturn('',$message,$status); $this->assign('msgTitle',$status? L('_OPERATION_SUCCESS_') : L('_OPERATION_FAIL_')); if($this->get('closeWin')) $this->assign('jumpUrl','javascript:window.close();'); $this->assign('status',$status); $this->assign('message',$message); C('HTML_CACHE_ON',false); if($status) { if(!$this->get('waitSecond')) $this->assign('waitSecond',"1"); if(!$this->get('jumpUrl')) $this->assign("jumpUrl",$_SERVER["HTTP_REFERER"]); $this->display(C('TMPL_ACTION_SUCCESS')); }else{ if(!$this->get('waitSecond')) $this->assign('waitSecond',"3"); if(!$this->get('jumpUrl')) $this->assign('jumpUrl',"javascript:history.back(-1);"); $this->display(C('TMPL_ACTION_ERROR')); } if(C('LOG_RECORD')) Log::save(); exit ; } } class View extends Think { protected $tVar = array(); protected $trace = array(); protected $templateFile = ''; public function assign($name,$value=''){ if(is_array($name)) { $this->tVar = array_merge($this->tVar,$name); }elseif(is_object($name)){ foreach($name as $key =>$val) $this->tVar[$key] = $val; }else { $this->tVar[$name] = $value; } } public function trace($title,$value='') { if(is_array($title)) $this->trace = array_merge($this->trace,$title); else $this->trace[$title] = $value; } public function get($name){ if(isset($this->tVar[$name])) return $this->tVar[$name]; else return false; } public function display($templateFile='',$charset='',$contentType='text/html') { $this->fetch($templateFile,$charset,$contentType,true); } protected function layout($content,$charset='',$contentType='text/html') { if(false !== strpos($content,'<!-- layout')) { $find = preg_match_all('/<!-- layout::(.+?)::(.+?) -->/is',$content,$matches); if($find) { for ($i=0; $i< $find; $i++) { if(0===strpos($matches[1][$i],'$')) $matches[1][$i] = $this->get(substr($matches[1][$i],1)); if(0 != $matches[2][$i] ) { $guid = md5($matches[1][$i]); $cache = S($guid); if($cache) { $layoutContent = $cache; }else{ $layoutContent = $this->fetch($matches[1][$i],$charset,$contentType); S($guid,$layoutContent,$matches[2][$i]); } }else{ $layoutContent = $this->fetch($matches[1][$i],$charset,$contentType); } $content = str_replace($matches[0][$i],$layoutContent,$content); } } } return $content; } public function fetch($templateFile='',$charset='',$contentType='text/html',$display=false) { $GLOBALS['_viewStartTime'] = microtime(TRUE); if(null===$templateFile) return ; if(empty($charset)) $charset = C('DEFAULT_CHARSET'); header("Content-Type:".$contentType."; charset=".$charset); header("Cache-control: private"); ob_start(); ob_implicit_flush(0); if(!file_exists_case($templateFile)) $templateFile = $this->parseTemplateFile($templateFile); $engine = strtolower(C('TMPL_ENGINE_TYPE')); if('php'==$engine) { extract($this->tVar, EXTR_OVERWRITE); include $templateFile; }elseif('think'==$engine && $this->checkCache($templateFile)) { extract($this->tVar, EXTR_OVERWRITE); include C('CACHE_PATH').md5($templateFile).C('TMPL_CACHFILE_SUFFIX'); }else{ $className = 'Template'.ucwords($engine); require_cache(THINK_PATH.'/Lib/Think/Util/Template/'.$className.'.class.php'); $tpl = new $className; $tpl->fetch($templateFile,$this->tVar,$charset); } $this->templateFile = $templateFile; $content = ob_get_clean(); $content = $this->templateContentReplace($content); $content = $this->layout($content,$charset,$contentType); return $this->output($content,$display); } protected function checkCache($tmplTemplateFile) { if (!C('TMPL_CACHE_ON')) return false; $tmplCacheFile = C('CACHE_PATH').md5($tmplTemplateFile).C('TMPL_CACHFILE_SUFFIX'); if(!is_file($tmplCacheFile)){ return false; }elseif (filemtime($tmplTemplateFile) > filemtime($tmplCacheFile)) { return false; }elseif (C('TMPL_CACHE_TIME') != -1 && time() > filemtime($tmplCacheFile)+C('TMPL_CACHE_TIME')) { return false; } return true; } public function buildHtml($htmlfile,$htmlpath='',$templateFile='',$charset='',$contentType='text/html') { $content = $this->fetch($templateFile,$charset,$contentType); $htmlpath = !empty($htmlpath)?$htmlpath:HTML_PATH; $htmlfile = $htmlpath.$htmlfile.C('HTML_FILE_SUFFIX'); if(!is_dir(dirname($htmlfile))) mk_dir(dirname($htmlfile)); if(false === file_put_contents($htmlfile,$content)) throw_exception(L('_CACHE_WRITE_ERROR_')); return $content; } protected function output($content,$display) { if(C('HTML_CACHE_ON')) HtmlCache::writeHTMLCache($content); if($display) { if(C('SHOW_RUN_TIME')){ $runtime = '<div  id="think_run_time" class="think_run_time">'.$this->showTime().'</div>'; if(strpos($content,'{__RUNTIME__}')) $content = str_replace('{__RUNTIME__}',$runtime,$content); else $content .= $runtime; } echo $content; if(C('SHOW_PAGE_TRACE')) $this->showTrace(); return null; }else { return $content; } } protected function templateContentReplace($content) { $replace = array( '../Public' => APP_PUBLIC_PATH, '__PUBLIC__' => WEB_PUBLIC_PATH, '__TMPL__' => APP_TMPL_PATH, '__ROOT__' => __ROOT__, '__APP__' => __APP__, '__URL__' => __URL__, '__ACTION__' => __ACTION__, '__SELF__' => __SELF__, ); if(C('TOKEN_ON')) { if(strpos($content,'{__TOKEN__}')) { $replace['{__TOKEN__}'] = $this->buildFormToken(); }elseif(strpos($content,'{__NOTOKEN__}')){ $replace['{__NOTOKEN__}'] = ''; }elseif(preg_match('/<\/form(\s*)>/is',$content,$match)) { $replace[$match[0]] = $this->buildFormToken().$match[0]; } } if(is_array(C('TMPL_PARSE_STRING')) ) $replace = array_merge($replace,C('TMPL_PARSE_STRING')); $content = str_replace(array_keys($replace),array_values($replace),$content); return $content; } private function buildFormToken() { $tokenName = C('TOKEN_NAME'); $tokenType = C('TOKEN_TYPE'); $tokenValue = $tokenType(microtime(TRUE)); $token = '<input type="hidden" name="'.$tokenName.'" value="'.$tokenValue.'" />'; $_SESSION[$tokenName] = $tokenValue; return $token; } private function parseTemplateFile($templateFile) { if(''==$templateFile) { $templateFile = C('TMPL_FILE_NAME'); }elseif(strpos($templateFile,'@')){ $templateFile = TMPL_PATH.str_replace(array('@',':'),'/',$templateFile).C('TMPL_TEMPLATE_SUFFIX'); }elseif(strpos($templateFile,':')){ $templateFile = TEMPLATE_PATH.'/'.str_replace(':','/',$templateFile).C('TMPL_TEMPLATE_SUFFIX'); }elseif(!is_file($templateFile)) { $templateFile = dirname(C('TMPL_FILE_NAME')).'/'.$templateFile.C('TMPL_TEMPLATE_SUFFIX'); } if(!file_exists_case($templateFile)) throw_exception(L('_TEMPLATE_NOT_EXIST_').'['.$templateFile.']'); return $templateFile; } private function showTime() { $startTime = $GLOBALS['_viewStartTime']; $endTime = microtime(TRUE); $total_run_time = number_format(($endTime - $GLOBALS['_beginTime']), 3); $showTime = 'Process: '.$total_run_time.'s '; if(C('SHOW_ADV_TIME')) { $_load_time = number_format(($GLOBALS['_loadTime'] -$GLOBALS['_beginTime'] ), 3); $_init_time = number_format(($GLOBALS['_initTime'] -$GLOBALS['_loadTime'] ), 3); $_exec_time = number_format(($startTime -$GLOBALS['_initTime'] ), 3); $_parse_time = number_format(($endTime - $startTime), 3); $showTime .= '( Load:'.$_load_time.'s Init:'.$_init_time.'s Exec:'.$_exec_time.'s Template:'.$_parse_time.'s )'; } if(C('SHOW_DB_TIMES') && class_exists('Db',false) ) { $db = Db::getInstance(); $showTime .= ' | DB :'.$db->Q().' queries '.$db->W().' writes '; } if(C('SHOW_CACHE_TIMES') && class_exists('Cache',false)) { $cache = Cache::getInstance(); $showTime .= ' | Cache :'.$cache->Q().' gets '.$cache->W().' writes '; } if(MEMORY_LIMIT_ON && C('SHOW_USE_MEM')) { $startMem = array_sum(explode(' ', $GLOBALS['_startUseMems'])); $endMem = array_sum(explode(' ', memory_get_usage())); $showTime .= ' | UseMem:'. number_format(($endMem - $startMem)/1024).' kb'; } return $showTime; } private function showTrace(){ $traceFile = CONFIG_PATH.'trace.php'; $_trace = is_file($traceFile)? include $traceFile : array(); $this->trace('当前页面', $_SERVER['REQUEST_URI']); $this->trace('模板缓存', C('CACHE_PATH').md5($this->templateFile).C('TMPL_CACHFILE_SUFFIX')); $this->trace('请求方法', $_SERVER['REQUEST_METHOD']); $this->trace('通信协议', $_SERVER['SERVER_PROTOCOL']); $this->trace('请求时间', date('Y-m-d H:i:s',$_SERVER['REQUEST_TIME'])); $this->trace('用户代理', $_SERVER['HTTP_USER_AGENT']); $this->trace('会话ID' , session_id()); $log = Log::$log; $this->trace('日志记录',count($log)?count($log).'条日志<br/>'.implode('<br/>',$log):'无日志记录'); $files = get_included_files(); $this->trace('加载文件', count($files).str_replace("\n",'<br/>',substr(substr(print_r($files,true),7),0,-2))); $_trace = array_merge($_trace,$this->trace); include C('TMPL_TRACE_FILE'); } } alias_import(array( 'Model' => THINK_PATH.'/Lib/Think/Core/Model.class.php', 'Dispatcher' => THINK_PATH.'/Lib/Think/Util/Dispatcher.class.php', 'HtmlCache' => THINK_PATH.'/Lib/Think/Util/HtmlCache.class.php', 'Db' => THINK_PATH.'/Lib/Think/Db/Db.class.php', 'ThinkTemplate' => THINK_PATH.'/Lib/Think/Template/ThinkTemplate.class.php', 'Template' => THINK_PATH.'/Lib/Think/Util/Template.class.php', 'TagLib' => THINK_PATH.'/Lib/Think/Template/TagLib.class.php', 'Cache' => THINK_PATH.'/Lib/Think/Util/Cache.class.php', 'Debug' => THINK_PATH.'/Lib/Think/Util/Debug.class.php', 'Session' => THINK_PATH.'/Lib/Think/Util/Session.class.php', 'TagLibCx' => THINK_PATH.'/Lib/Think/Template/TagLib/TagLibCx.class.php', 'ViewModel' => THINK_PATH.'/Lib/Think/Core/Model/ViewModel.class.php', 'AdvModel' => THINK_PATH.'/Lib/Think/Core/Model/AdvModel.class.php', 'RelationModel' => THINK_PATH.'/Lib/Think/Core/Model/RelationModel.class.php', ) ); function arr2file($filename, $arr=''){ if(is_array($arr)){ $con = var_export($arr,true); } else{ $con = $arr; } $con = "<?php\nreturn $con;\n?>"; write_file($filename, $con); } function mkdirss($dirs,$mode=0777) { if(!is_dir($dirs)){ mkdirss(dirname($dirs), $mode); return @mkdir($dirs, $mode); } return true; } function write_file($l1, $l2=''){ $dir = dirname($l1); if(!is_dir($dir)){ mkdirss($dir); } return @file_put_contents($l1, $l2); } function read_file($l1){ return @file_get_contents($l1); } function t2js($l1, $l2=1){ $I1 = str_replace(array("\r", "\n"), array('', '\n'), addslashes($l1)); return $l2 ? "document.write(\"$I1\");" : $I1; } function u2g($str){ return iconv("UTF-8","GBK",$str); } function g2u($str){ return iconv("GBK","UTF-8//ignore",$str); } function http_url(){ return htmlspecialchars("http://".$_SERVER['HTTP_HOST'].$_SERVER["REQUEST_URI"]); } function xtime($day){ $day = intval($day); return mktime(23,59,59,date("m"),date("d")-$day,date("y")); } function get_base_path($filename){ $base_path = $_SERVER['PHP_SELF']; $base_path = substr($base_path,0,strpos($base_path,$filename)); return $base_path; } function get_base_url($baseurl,$url){ if("#" == $url){ return ""; }elseif(FALSE !== stristr($url,"http://")){ return $url; }elseif( "/" == substr($url,0,1) ){ $tmp = parse_url($baseurl); return $tmp["scheme"]."://".$tmp["host"].$url; }else{ $tmp = pathinfo($baseurl); return $tmp["dirname"]."/".$url; } } function get_replace_input($str,$rptype=0){ $str = stripslashes($str); $str = htmlspecialchars($str); $str = get_replace_nb($str); return addslashes($str); } function get_replace_nr($str){ $str = str_replace(array("<nr/>","<rr/>"),array("\n","\r"),$str); return trim($str); } function get_replace_nb($str){ $str = str_replace("&nbsp;",' ',$str); $str = str_replace("　",' ',$str); $str = ereg_replace("[\r\n\t ]{1,}",' ',$str); return trim($str); } function get_replace_html($str, $start=0, $length, $charset="utf-8", $suffix=false){ return msubstr(eregi_replace('<[^>]+>','',ereg_replace("[\r\n\t ]{1,}",' ',get_replace_nb($str))),$start,$length,$charset,$suffix); } function get_replace_order($order){ $arrorder['addtime'] = 'addtime'; $arrorder['id'] = 'id'; $arrorder['hits'] = 'hits'; $arrorder['monthhits'] = 'monthhits'; $arrorder['weekhits'] = 'weekhits'; $arrorder['dayhits'] = 'dayhits'; $arrorder['stars'] = 'stars'; $arrorder['up'] = 'up'; $arrorder['down'] = 'down'; $arrorder['score'] = 'score'; $arrorder['scoreer'] = 'scoreer'; return $arrorder[trim($order)]; } function check_model($modelname){ if(strtolower(MODULE_NAME) == $modelname){ return 1; } return 0; } function get_model_name($mid){ if ($mid==1){ return 'video'; }elseif ($mid==2){ return 'info'; }elseif ($mid==3){ return 'special'; }elseif ($mid==4){ return 'user'; } } function get_model_id($str){ if ($mid=='video'){ return 1; }elseif ($mid=='info'){ return 2; }elseif ($mid=='special'){ return 3; }elseif ($mid=='user'){ return 4; } } function get_channel_son($pid){ $tree = list_search(F('_gxcms/channeltree'),'id='.$pid); if(!empty($tree[0]['son'])){ return false; }else{ return true; } } function get_channel_name($cid,$type='cname'){ $arr = list_search(F('_gxcms/channel'),'id='.$cid); if (is_array($arr)) { return $arr[0][$type]; }else{ return $cid; } } function get_channel_array($cid,$type='id'){ $tree = list_search(F('_gxcms/channeltree'),'id='.$cid); if(!empty($tree[0]['son'])){ foreach($tree[0]['son'] as $val){ $param[] = $val[$type]; } return $param; }else{ return false; } } function get_channel_count($cid=0){ $where['status'] = 1; if ($cid > 0) { $where['cid'] = get_channel_sqlin($cid); }elseif ($cid == 0) { $where['addtime'] = array('gt',xtime(1)); } $mid = get_channel_name($cid,'mid'); if ($mid == 2){ $rs = M("Info"); }else{ $rs = M("Video"); } $count = $rs->where($where)->count('id'); return $count+0; } function get_channel_sqlin($cid){ $tree = list_search(F('_gxcms/channeltree'),'id='.$cid); if (!empty($tree[0]['son'])) { foreach($tree[0]['son'] as $val){ $arr['cid'][] = $val['id']; } $channel = implode(',', $arr['cid']); return array('IN',''.$channel.''); } return $cid; } function get_channel_remove($cids){ foreach($cids as $key=>$value){ if(get_channel_son($value)){ $cid .= ','.$value; }else{ $cidin = get_channel_sqlin($value); $cid .= ','.$cidin[1]; } } $cidarr = explode(',',$cid); unset($cidarr[0]); $cidarr = array_unique($cidarr); return $cidarr; } function get_cms_page_max($count,$limit,$page){ $totalPages = ceil($count/$limit); if ($page > $totalPages){ $page = $totalPages; } return $page; } function get_cms_page($totalrecords,$pagesize,$currentpage,$params,$filename='条数据',$pagego=true,$halfPer=5){ $page['totalrecords'] = $totalrecords; $page['totalpages'] = ceil($page['totalrecords']/$pagesize); $page['currentpage'] = $currentpage; $page['urlpage'] = $params.'{!page!}'; $page['listpages'] = '共'.$page['totalrecords'].$filename.'&nbsp;当前：'.$page['currentpage'].'/'.$page['totalpages'].'页&nbsp;'; if ($pagego){ $pagego = 'jumpurl(\''.$page['urlpage'].'\','.$page['totalpages'].')'; } $page['listpages'] .= get_cms_page_css($page['currentpage'],$page['totalpages'],$halfPer,$page['urlpage'],$pagego); return $page; } function get_cms_page_css($currentPage,$totalPages,$halfPer=5,$url,$pagego){ $linkPage .= ( $currentPage > 1 ) ? '<a href="'.str_replace('{!page!}',1,$url).'" class="pagegbk">首页</a>&nbsp;<a href="'.str_replace('{!page!}',($currentPage-1),$url).'" class="pagegbk">上一页</a>&nbsp;' : '<em>首页</em>&nbsp;<em>上一页</em>&nbsp;'; for($i=$currentPage-$halfPer,$i>1||$i=1,$j=$currentPage+$halfPer,$j<$totalPages||$j=$totalPages;$i<$j+1;$i++){ $linkPage .= ($i==$currentPage)?'<span>'.$i.'</span>&nbsp;':'<a href="'.str_replace('{!page!}',$i,$url).'">'.$i.'</a>&nbsp;'; } $linkPage .= ( $currentPage < $totalPages ) ? '<a href="'.str_replace('{!page!}',($currentPage+1),$url).'" class="pagegbk">下一页</a>&nbsp;<a href="'.str_replace('{!page!}',$totalPages,$url).'" class="pagegbk">尾页</a>' : '<em>下一页</em>&nbsp;<em>尾页</em>'; if(!empty($pagego)){ $linkPage .='&nbsp;<input type="input" name="page" id="page" class="pageinput"/><input type="button" value="跳 转" onclick="'.$pagego.'" class="pagebg"/>'; } return str_replace('_1'.C('html_file_suffix'),C('html_file_suffix'),str_replace('index1'.C('html_file_suffix'),'',$linkPage)); } function get_cms_ads($str,$charset="utf-8"){ return '<script type="text/javascript" src="'.C('web_path').C('web_adsensepath').'/'.$str.'.js" charset="utf-8"></script>'; } function get_color_title($str,$color){ if (empty($color)) { return $str; }else{ return '<font color="'.$color.'">'.$str.'</font>'; } } function get_color_date($type='Y-m-d H:i:s',$time,$color='red'){ if($time > xtime(1)){ return '<font color="'.$color.'">'.date($type,$time).'</font>'; }else{ return date($type,$time); } } function get_hot_key($string){ $array = explode('|',$string); if(C('url_html')){ return '<script type="text/javascript" src="'.C('web_path').'temp/Js/hot.js" charset="utf-8"></script>'; } $hotkey = ''; foreach($array as $key=>$value){ $hotkey .= '<a href="'.C('web_path').'index.php?s=video/search/wd/'.urlencode($value).'">'.$value.'</a>'; } return $hotkey; } function get_jifen($fen){ $array = explode('.',$fen); return '<strong>'.$array[0].'</strong>.'.$array[1]; } function get_hilight($string,$keyword,$classname='kw-hilight'){ return str_replace($keyword,'<span class="kw-hilight">'.$keyword.'</span>',$string); } function get_actor_url($str,$num,$keyword,$classname){ $str = str_replace(' ','/',str_replace(',','/',$str)); $arr = explode('/',$str); foreach($arr as $key=>$val){ $value = $val; if($keyword){ $value = get_hilight($value,$keyword,'a'); } $restr .= '<a href="'.C('web_path').'index.php?s=video/search/wd/'.urlencode($val).'" target="_blank">'.$value.'</a> '; if(($key+1) == $num){ break; } } return $restr; } function get_letter_url($cid,$letter='',$mid='video'){ if($cid){ $arrurl['id'] = $cid; } for($i=1;$i<=26;$i++){ $arrurl['letter'] = chr($i+64); $url = str_replace('index.php?s=/Home/','index.php?s=',U('Home-'.$mid.'/lists',$arrurl,false,true)); if($letter == $arrurl['letter']){ $str .='<a href="'.$url.'" class="Letter">'.$arrurl['letter'].'</a>'; }else{ $str .='<a href="'.$url.'">'.$arrurl['letter'].'</a>'; } } return $str; } function get_img_url_preg($file,$content,$number=1){ preg_match_all('/<img(.*?)src="(.*?)(?=")/si',$content,$imgarr); preg_match_all('/(?<=src=").*?(?=")/si',implode('" ',$imgarr[0]).'" ',$imgarr); $countimg = count($imgarr); if($number > $countimg){ $number = $countimg; } return $imgarr[0][($number-1)]; } function get_img_url($file,$content,$number=1){ if(!$file){ return get_img_url_preg($file,$content,$number); } if(strpos($file,'http://') !== false){ return $file; } $prefix = C('upload_ftp_url'); if(!empty($prefix)){ return $prefix.$file; }else{ return C('web_path').C('upload_path').'/'.$file; } } function get_img_url_s($file,$content,$number=1){ if(!$file){ return get_img_url_preg($file,$content,$number); } if(strpos($file,'http://') !== false){ return $file; } $prefix = C('upload_ftp_url'); if(!empty($prefix)){ return $prefix.$file; }else{ return C('web_path').C('upload_path').'-s/'.$file; } } function get_play_name($i,$count){ if($count>99){ if($i<10){ return str_pad($i,3,'0',STR_PAD_LEFT); } if(10<=$i && $i<100){ return str_pad($i,3,'0',STR_PAD_LEFT); } } if($count>9 && $i<10){ return str_pad($i,2,'0',STR_PAD_LEFT); } return $i; } function get_show_url($mid,$arrurl,$page){ if(C('url_html') && C('url_html_channel') && in_array($mid,array('video','info','special'))){ $showurl = C('web_path').str_replace('index'.C('html_file_suffix'),'',get_show_url_dir($mid,$arrurl['id'],$page).C('html_file_suffix')); }else{ if($page > 1){ $arrurl['p'] = '{!page!}'; } $showurl = str_replace('index.php?s=/Home/','index.php?s=',U('Home-'.$mid.'/lists',$arrurl,false,true)); if(C('url_rewrite')){ $showurl = str_replace('index.php?s=','',$showurl); $showurl = str_replace(array("video/lists/id", "info/lists/id"), array('list', 'newslist'), $showurl); }elseif(!C('url_html')){ $showurl = str_replace('index.php','',$showurl); } } return $showurl; } function get_show_url_dir($mid,$cid,$page){ if('special' == $mid){ $showdir = trim(C('url_dir_special')).'/index'; if($page > 1){ $showdir .= '{!page!}'; } return $showdir; } if(C('url_html_rule') == 1){ $listdir = trim(C('url_dir_all')); $listdir = !empty($listdir)?$listdir.'/':''; $showdir = $listdir.get_channel_name($cid,'cfile').'/index'; if($page > 1){ $showdir .= '{!page!}'; } return $showdir; } $showdir = trim(C('url_dir_'.$mid)); if($showdir){ $showdir .= '/'; } if(C('url_html_rule') == 2){ $showdir .= $cid; if($page > 1){ $showdir .= '_{!page!}'; } return $showdir; } $showdir .= get_channel_name($cid,'cfile'); if($page > 1){ $showdir .= '_{!page!}'; } return $showdir; } function get_read_url($mid,$id,$cid,$jumpurl,$name,$page){ if ($jumpurl) { return $jumpurl; } if(C('url_html')){ $readurl = C('web_path').str_replace('index'.C('html_file_suffix'),'',get_read_url_dir($mid,$id,$cid,$name,$page).C('html_file_suffix')); return $readurl; } $arrurl['id'] = $id; $readurl = str_replace('index.php?s=/Home/','index.php?s=',U('Home-'.$mid.'/detail',$arrurl,false,true)); if(C('url_rewrite')){ $readurl = str_replace('index.php?s=','',$readurl); $readurl = str_replace(array("video/detail/id", "info/detail/id"), array('movie', 'news'), $readurl); }else{ $readurl = str_replace('index.php','',$readurl); } return $readurl; } function get_read_url_dir($mid,$id,$cid,$name,$page){ if('special' == $mid){ return trim(C('url_dir_special').'/'.$id); } if(C('url_html_rule') == 1){ $listdir = trim(C('url_dir_all')); $listdir = !empty($listdir)?$listdir.'/':''; $readdir = $listdir.get_channel_name($cid,'cfile').'/'.$id.'/index'; return $readdir; } $readdir = trim(C('url_dir_'.$mid.'read')); $readdir = !empty($readdir)?$readdir.'/':''; if(C('url_html_rule') == 2){ $readdir .= $id; return $readdir; } $readdir .= get_channel_name($cid,'cfile').$id; return $readdir; } function get_play_url($id,$cid,$ji){ if(C('url_html')){ if(C('url_html_play')){ $playurl = C('web_path').str_replace('index'.C('html_file_suffix'),'',get_play_url_dir($id,$cid,$ji).C('html_file_suffix')); if(C('url_html_play') == 1){ $playurl .= '?'.$id.'-'.$ji; } }else{ $playurl = str_replace('index.php?s=/Home/','index.php?s=',U('Home-video/play/id/'.$id.'-'.$ji)); if(C('url_rewrite')){ $playurl = str_replace('index.php?s=','',$playurl); $playurl = str_replace("video/play/id","player", $playurl); } } }else{ $playurl = str_replace('index.php?s=/Home/','index.php?s=',U('Home-video/play/id/'.$id.'-'.$ji)); if(C('url_rewrite')){ $playurl = str_replace('index.php?s=','',$playurl); $playurl = str_replace("video/play/id","player", $playurl); }else{ $playurl = str_replace('index.php','',$playurl); } } return $playurl; } function get_play_url_dir($id,$cid,$ji){ if(C('url_html_rule') == 1){ $listdir = trim(C('url_dir_all')); $listdir = !empty($listdir)?$listdir.'/':''; $playdir = $listdir.get_channel_name($cid,'cfile').'/'; if(C('url_html_play') == 1){ return $playdir.$id.'/play'; } return $playdir.$id.'/'.$id.'-'.$ji; } $playdir = trim(C('url_dir_videoplay')); $playdir = !empty($playdir)?$playdir.'/':''; if(C('url_html_rule') == 2){ if(C('url_html_play') == 1){ return $playdir.$id; } return $playdir.$id.'-'.$ji; } if(C('url_html_play') == 1){ return $playdir.get_channel_name($cid,'cfile').$id; } return $playdir.get_channel_name($cid,'cfile').$id.'-'.$ji; } function get_tag_gxcms($tag){ $table = !empty($tag['name'])?trim($tag['name']):'video'; $field = !empty($tag['field'])?trim($tag['field']):'*'; $limit = !empty($tag['limit'])?trim($tag['limit']):'10'; $order = !empty($tag['order'])?trim($tag['order']):'addtime desc'; if($table != 'link'){ $where['status'] = array('eq',1); } if ($tag['time']) { $where['addtime'] = array('gt',xtime($tag['time'])); } if ($tag['hits']) { $hits = explode(',',trim($tag['hits'])); if (count($hits)>1) { $where['hits'] = array('between',$hits[0].','.$hits[1]); }else{ $where['hits'] = array('gt',$hits[0]); } } if ($tag['cid']) { $cids = explode(',',trim($tag['cid'])); if (count($cids)>1) { $where['cid'] = array('in',get_channel_remove($cids)); }else{ $where['cid'] = get_channel_sqlin($tag['cid']); } } if ($tag['ids']) { $where['id'] = array('in',trim($tag['ids'])); } if ($tag['stars']) { $where['stars'] = array('in',trim($tag['stars'])); } if ($tag['letter']) { $where['letter'] = array('eq',trim($tag['letter'])); } if ($tag['keyword']) { $keyword = trim($tag['keyword']); $where['title'] = array('like','%'.$keyword.'%'); } if ($tag['serial'] && $table=='video') { $serial = trim($tag['serial']); if ('all' == $serial) { $where['serial'] = array('neq',0); }else{ $where['serial'] = array('gt',$serial); } } if ($tag['up']) { $up = explode(',',trim($tag['up'])); if (count($up)>1) { $where['up'] = array('between',$up[0].','.$up[1]); }else{ $where['up'] = array('gt',$up[0]); } } if ($tag['down']) { $down = explode(',',trim($tag['down'])); if (count($down)>1) { $where['down'] = array('between',$down[0].','.$down[1]); }else{ $where['down'] = array('gt',$down[0]); } } if ($tag['score']) { $score = explode(',',trim($tag['score'])); if (count($score)>1) { $where['score'] = array('between',$score[0].','.$score[1]); }else{ $where['score'] = array('gt',$score[0]); } } if ($tag['scoreer']) { $scoreer = explode(',',trim($tag['scoreer'])); if (count($scoreer)>1) { $where['scoreer'] = array('between',$scoreer[0].','.$scoreer[1]); }else{ $where['scoreer'] = array('gt',$scoreer[0]); } } $rs = M($table); $list = $rs->field($field)->where($where)->order($order)->limit($limit)->select(); if('special'==$table){ foreach($list as $key=>$val){ $list[$key]['readurl'] = get_read_url($table,$list[$key]['id'],$list[$key]['cid']); $list[$key]['logo'] = get_img_url($list[$key]['logo']); $list[$key]['banner'] = get_img_url_s($list[$key]['banner']); } }else{ foreach($list as $key=>$val){ $list[$key]['showname'] = get_channel_name($list[$key]['cid']); $list[$key]['showurl'] = get_show_url($table,array('id'=>$list[$key]['cid']),1); $list[$key]['readurl'] = get_read_url($table,$list[$key]['id'],$list[$key]['cid'],$list[$key]['jumpurl']); $list[$key]['playerurl'] = get_play_url($list[$key]['id'],$list[$key]['cid'],1); $list[$key]['picurlsmall'] = get_img_url_s($list[$key]['picurl'],$list[$key]['content']); $list[$key]['picurl'] = get_img_url($list[$key]['picurl'],$list[$key]['content']); } } return $list; } function get_tag_gxlist($tag){ $table = !empty($tag['name']) ? trim($tag['name']) : 'video'; $field = !empty($tag['field']) ? trim($tag['field']) : '*'; $limit = !empty($tag['limit']) ? trim($tag['limit']) : '10'; $order = !empty($tag['order']) ? trim($tag['order']).' desc' : 'addtime desc'; $page = C('bdlist_page'); if(C('bdlist_where')){ $where = C('bdlist_where'); }else{ if(C('bdlist_ids')){ $where['cid'] = C('bdlist_ids'); } $where['status'] = array('eq',1); } $rs = M($table); $list = $rs->field($field)->where($where)->limit($limit)->page($page)->order($order)->select(); if('special'==$table){ foreach($list as $key=>$val){ $list[$key]['readurl'] = get_read_url($table,$list[$key]['id'],$list[$key]['cid']); $list[$key]['logo'] = get_img_url($list[$key]['logo']); $list[$key]['banner'] = get_img_url_s($list[$key]['banner']); } }else{ foreach($list as $key=>$val){ $list[$key]['showname'] = get_channel_name($list[$key]['cid']); $list[$key]['showurl'] = get_show_url($table,array('id'=>$list[$key]['cid']),1); $list[$key]['readurl'] = get_read_url($table,$list[$key]['id'],$list[$key]['cid'],$list[$key]['jumpurl']); $list[$key]['playerurl'] = get_play_url($list[$key]['id'],$list[$key]['cid'],1); $list[$key]['picurl'] = get_img_url($list[$key]['picurl'],$list[$key]['content']); $list[$key]['picurl-s'] = get_img_url_s($list[$key]['picurl'],$list[$key]['content']); } } return $list; } function get_tag_gxsearch($tag){ $table = !empty($tag['name']) ? trim($tag['name']) : 'video'; $field = !empty($tag['field']) ? trim($tag['field']) : '*'; $limit = !empty($tag['limit']) ? trim($tag['limit']) : '10'; $order = !empty($tag['order']) ? trim($tag['order']).' desc' : 'addtime desc'; $page = C('bdsearch_page'); $where = C('bdsearch_where'); $rs = M($table); $list = $rs->field($field)->where($where)->limit($limit)->page($page)->order($order)->select(); if (empty($list)) { C($table.'empty',true); } foreach($list as $key=>$val){ $list[$key]['showname'] = get_channel_name($list[$key]['cid']); $list[$key]['showurl'] = get_show_url($table,array('id'=>$list[$key]['cid']),1); $list[$key]['readurl'] = get_read_url($table,$list[$key]['id'],$list[$key]['cid'],$list[$key]['jumpurl']); $list[$key]['playerurl'] = get_play_url($list[$key]['id'],$list[$key]['cid'],1); $list[$key]['picurl'] = get_img_url($list[$key]['picurl'],$list[$key]['content']); $list[$key]['picurl-s'] = get_img_url_s($list[$key]['picurl'],$list[$key]['content']); } return $list; } function get_tag_gxmenu($tag){ $listtree = F('_gxcms/channeltree'); if ($tag['ids']) { $list = F('_gxcms/channel'); $arrcid = explode(',',trim($tag['ids'])); foreach($arrcid as $key=>$value){ $cidvalue = list_search($listtree,'id='.$value); if (empty($cidvalue)) { $cidvalue = list_search($list,'id='.$value); } $newtree[$key] = $cidvalue[0]; } $listtree = $newtree; } return $listtree; } function get_tag_hits($mid,$type='hits',$array,$js=true){ if((C('url_html') && $js) || $type=='insert'){ return '<script type="text/javascript" src="'.C('web_path').'index.php?s=hits/show/id/'.$array['id'].'/type/'.$type.'/mid/'.$mid.'" charset="utf-8"></script>'; }else{ return $array[$type]; } } function get_url_where(){ $where['page'] = !empty($_GET['p']) ? intval($_GET['p']) : 1; $where['year'] = intval($_REQUEST['year']); $where['id'] = intval($_REQUEST['id']); $where['letter'] = htmlspecialchars($_REQUEST['letter']); $where['area'] = htmlspecialchars(urldecode(trim($_REQUEST['area']))); $where['wd'] = htmlspecialchars(urldecode(trim($_REQUEST['wd']))); $where['order'] = !empty($_GET['order']) ? get_replace_order($_GET['order']) : 'addtime'; return $where; } function get_letter($s0){ $firstchar_ord = ord(strtoupper($s0{0})); if (($firstchar_ord>=65 and $firstchar_ord<=91)or($firstchar_ord>=48 and $firstchar_ord<=57)) return $s0{0}; $s = iconv("UTF-8","gb2312", $s0); $asc = ord($s{0})*256+ord($s{1})-65536; if($asc>=-20319 and $asc<=-20284)return "A"; if($asc>=-20283 and $asc<=-19776)return "B"; if($asc>=-19775 and $asc<=-19219)return "C"; if($asc>=-19218 and $asc<=-18711)return "D"; if($asc>=-18710 and $asc<=-18527)return "E"; if($asc>=-18526 and $asc<=-18240)return "F"; if($asc>=-18239 and $asc<=-17923)return "G"; if($asc>=-17922 and $asc<=-17418)return "H"; if($asc>=-17417 and $asc<=-16475)return "J"; if($asc>=-16474 and $asc<=-16213)return "K"; if($asc>=-16212 and $asc<=-15641)return "L"; if($asc>=-15640 and $asc<=-15166)return "M"; if($asc>=-15165 and $asc<=-14923)return "N"; if($asc>=-14922 and $asc<=-14915)return "O"; if($asc>=-14914 and $asc<=-14631)return "P"; if($asc>=-14630 and $asc<=-14150)return "Q"; if($asc>=-14149 and $asc<=-14091)return "R"; if($asc>=-14090 and $asc<=-13319)return "S"; if($asc>=-13318 and $asc<=-12839)return "T"; if($asc>=-12838 and $asc<=-12557)return "W"; if($asc>=-12556 and $asc<=-11848)return "X"; if($asc>=-11847 and $asc<=-11056)return "Y"; if($asc>=-11055 and $asc<=-10247)return "Z"; return 0; } function get_collect_file($url){ for($i=0;$i<3;$i++){ $content = @file_get_contents($url); if($content) break; } if($content){ return $content; } if(function_exists('curl_init')){ $ch = curl_init(); curl_setopt ($ch, CURLOPT_URL, $url); curl_setopt ($ch, CURLOPT_HEADER, 0); curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt ($ch, CURLOPT_CONNECTTIMEOUT,10); $content = curl_exec($ch); curl_close($ch); if($content){ return $content; } } return false; } function get_collect_krsort($listurl){ krsort($listurl); foreach($listurl as $val){ $list[]=$val; } return $list; } function get_collect_match($rule,$html){ $arr = explode('$$$',$rule); if(count($arr)==2){ preg_match('/'.$arr[1].'/', $html, $data); return $data[$arr[0]].''; }else{ preg_match('/'.$rule.'/', $html, $data); return $data[1].''; } } function get_collect_matchall($rule,$html){ $arr = explode('$$$',$rule); if(count($arr)==2){ preg_match_all('/'.$arr[1].'/', $html, $data); return $data[$arr[0]]; }else{ preg_match_all('/'.$rule.'/', $html, $data); return $data[1]; } } function getrole($str){ $arr1 = array('?','"','(',')','[',']','.','/',':','*','||',); $arr2 = array('\?','\"','\(','\)','\[','\]','\.','\/','\:','.*?','(.*?)',); return str_replace('\[$gxcms\]','([\s\S]*?)',str_replace($arr1,$arr2,$str)); } function getreplace($arr){ foreach($arr as $val){ $array[]=trim(stripslashes($val)); } return implode('|||',$array); } function getdomain($url){ preg_match("|http://(.*)\/|isU", $url, $arr_domain); return $arr_domain[1]; } function getbindval($key){ $bindcache = F('_collect/channel'); return $bindcache[$key]; } function get_collect_bind($pid){ $tree = list_search(F('_gxcms/channeltree'),'id='.$pid); if(!empty($tree[0]['son'])){ return false; }else{ return true; } } return array ( 'app_debug' => false, 'app_domain_deploy' => false, 'app_plugin_on' => false, 'app_file_case' => false, 'app_group_depr' => '.', 'app_group_list' => 'Admin,Home,Plus', 'app_autoload_reg' => false, 'app_autoload_path' => 'Think.Util.', 'app_config_list' => array ( 0 => 'taglibs', 1 => 'routes', 2 => 'tags', 3 => 'htmls', 4 => 'modules', 5 => 'actions', ), 'cookie_expire' => 3600, 'cookie_domain' => '', 'cookie_path' => '/', 'cookie_prefix' => '', 'default_app' => '@', 'default_group' => 'Home', 'default_module' => 'Index', 'default_action' => 'index', 'default_charset' => 'utf-8', 'default_timezone' => 'PRC', 'default_ajax_return' => 'JSON', 'default_theme' => 'boostrap', 'default_lang' => 'zh-cn', 'db_type' => 'mysql', 'db_host' => 'localhost', 'db_name' => '532movie', 'db_user' => 'root', 'db_pwd' => 'wulang', 'db_port' => '3306', 'db_prefix' => 'gx_', 'db_suffix' => '', 'db_fieldtype_check' => true, 'db_fields_cache' => true, 'db_charset' => 'utf8', 'db_deploy_type' => 0, 'db_rw_separate' => false, 'data_cache_time' => -1, 'data_cache_compress' => false, 'data_cache_check' => false, 'data_cache_type' => 'File', 'data_cache_path' => './temp/Temp/', 'data_cache_subdir' => true, 'data_path_level' => 2, 'error_message' => '您浏览的页面暂时发生了错误！请稍后再试～', 'error_page' => '', 'html_cache_on' => false, 'html_cache_time' => 0, 'html_read_type' => 0, 'html_file_suffix' => '.html', 'lang_switch_on' => false, 'lang_auto_detect' => true, 'log_record' => false, 'log_file_size' => 2097152, 'log_record_level' => array ( 0 => 'EMERG', 1 => 'ALERT', 2 => 'CRIT', 3 => 'ERR', ), 'page_rollpage' => 5, 'page_listrows' => 20, 'session_auto_start' => true, 'show_run_time' => false, 'show_adv_time' => false, 'show_db_times' => false, 'show_cache_times' => false, 'show_use_mem' => false, 'show_page_trace' => false, 'show_error_msg' => true, 'tmpl_engine_type' => 'Think', 'tmpl_detect_theme' => false, 'tmpl_template_suffix' => '.html', 'tmpl_cachfile_suffix' => '.php', 'tmpl_deny_func_list' => 'echo,exit', 'tmpl_parse_string' => '', 'tmpl_l_delim' => '{', 'tmpl_r_delim' => '}', 'tmpl_var_identify' => 'array', 'tmpl_strip_space' => false, 'tmpl_cache_on' => false, 'tmpl_cache_time' => -1, 'tmpl_action_error' => './views/tips/tips.html', 'tmpl_action_success' => './views/tips/tips.html', 'tmpl_trace_file' => './core/ThinkPHP/Tpl/PageTrace.tpl.php', 'tmpl_exception_file' => './core/ThinkPHP/Tpl/ThinkException.tpl.php', 'tmpl_file_depr' => '_', 'taglib_begin' => '<', 'taglib_end' => '>', 'taglib_load' => true, 'taglib_build_in' => 'cx', 'taglib_pre_load' => '', 'tag_nested_level' => 3, 'tag_extend_parse' => '', 'token_on' => true, 'token_name' => '__hash__', 'token_type' => 'md5', 'url_case_insensitive' => true, 'url_router_on' => false, 'url_dispatch_on' => true, 'url_model' => 3, 'url_pathinfo_model' => 2, 'url_pathinfo_depr' => '/', 'url_html_suffix' => '.html', 'var_group' => 'g', 'var_module' => 'm', 'var_action' => 'a', 'var_router' => 'r', 'var_page' => 'p', 'var_template' => 't', 'var_language' => 'l', 'var_ajax_submit' => 'ajax', 'var_pathinfo' => 's', 'web_ip' => '172.16.9.17', 'web_name' => '532movie', 'web_url' => 'localhost/', 'web_path' => '/532movie/', 'web_hotkey' => '碟中谍4|泰坦尼克号|战马|', 'web_keywords' => 'BNU校内电影分享站', 'web_author' => 'wulang,yanhl', 'web_description' => '532movie', 'web_email' => 'wulang@mail.bnu.edu.cn', 'web_qq' => '845428486', 'web_copyright' => '', 'web_tongji' => '', 'web_icp' => '', 'web_adsensepath' => 'temp/Banner', 'web_admin_pagenum' => 20, 'web_home_pagenum' => '5', 'web_admin_hits' => 500, 'web_hits_way' => '1', 'web_hits_time' => 5, 'web_admin_updown' => 100, 'web_admin_score' => 9, 'web_collect_num' => 2, 'web_admin_edittime' => true, 'web_admin_ordertype' => 'addtime', 'web_admin_language' => '国语,粤语,英语,韩语,日语,法语,西班牙语,德语,泰语,意大利,语中文字幕,英文字幕', 'web_admin_area' => '中国大陆,中国台湾,中国香港,韩国,日本,美国,英国,法国,意大利,德国,西班牙,泰国', 'web_admin_nav' => array ( '网站信息配置' => '?s=Admin/Config/Conf/id/web', '视频数据管理' => '?s=Admin/Video/Show', '影片采集中心' => '?s=Admin/Collect/Show', '网站栏目管理' => '?s=Admin/Channel/Show', '网站广告管理' => '?s=Admin/Adsense/Show', '快捷菜单设置' => '?s=Admin/Config/Conf/id/nav', ), 'upload_path' => 'uploads', 'upload_style' => 'Y-m-d', 'upload_thumb' => '0', 'upload_thumb_w' => 120, 'upload_thumb_h' => 168, 'upload_water' => '0', 'upload_water_img' => 'views/images/water.gif', 'upload_water_pct' => 80, 'upload_water_pos' => 9, 'upload_http_down' => 10, 'upload_http' => '0', 'upload_ftp' => '0', 'upload_ftp_host' => '255.255.255.255', 'upload_ftp_user' => 'username', 'upload_ftp_pass' => 'userpwd', 'upload_ftp_port' => 21, 'upload_ftp_dir' => '/', 'upload_ftp_url' => '', 'html_cache_index' => 1, 'html_cache_list' => 1, 'html_cache_content' => 1, 'html_cache_play' => 1, 'html_cache_mytpl' => '1', 'url_rewrite' => '0', 'url_html' => '0', 'url_html_rule' => '2', 'url_html_channel' => '0', 'url_html_play' => '0', 'url_create_time' => 2, 'url_create_num' => 30, 'url_dir_video' => 'vodlist', 'url_dir_videoread' => 'detail', 'url_dir_videoplay' => 'play', 'url_dir_info' => 'infolist', 'url_dir_inforead' => 'detail-n', 'url_dir_special' => 'special', 'url_dir_maps' => 'maps', 'url_dir_all' => '', 'user_register' => '1', 'user_comment' => '1', 'user_check' => '0', 'user_pay' => '0', 'user_post' => '0', 'user_paycid' => array ( 0 => '8', 1 => '9', 2 => '10', 3 => '11', 4 => '12', 5 => '13', 6 => '14', 7 => '3', 8 => '5', 9 => '6', ), 'user_money_play' => 1, 'user_money_change' => 100, 'user_money_add' => 50, 'user_check_time' => 60, 'user_page_cm' => 8, 'user_page_gb' => 10, 'user_replace' => '脏话|法轮功|枪械|A片|三级|伦理|毛片', '_htmls_' => array ( 'home:index:index' => array ( 0 => '{:action}', 1 => 3600, ), 'home:video:lists' => array ( 0 => '{:module}_{:action}/{$_SERVER.REQUEST_URI|md5}', 1 => 3600, ), 'home:info:lists' => array ( 0 => '{:module}_{:action}/{$_SERVER.REQUEST_URI|md5}', 1 => 3600, ), 'home:video:detail' => array ( 0 => '{:module}_{:action}/{id|md5}', 1 => 3600, ), 'home:info:detail' => array ( 0 => '{:module}_{:action}/{$_SERVER.REQUEST_URI|md5}', 1 => 3600, ), 'home:video:play' => array ( 0 => '{:module}_{:action}/{id|md5}', 1 => 3600, ), 'home:my:show' => array ( 0 => '{:module}_{:action}/{$_SERVER.REQUEST_URI|md5}', 1 => 3600, ), ), 'player_width' => 960, 'player_height' => 550, 'player_down' => '', 'player_buffer' => '', 'player_pause' => '', 'player_time' => '0', 'user_auth_key' => '532movie', 'not_auth_action' => 'index,show,add,top,left,main', 'require_auth_module' => 'Config,Cache,Master,Channel,Video,Info,Special,Collect,User,Userview,Comment,Gbook,Tpl,Adsense,Link,Upload,Html,Data,Slide', 'cms_admin' => 'index.php', 'cms_name' => '532Movie影视分享系统', 'cms_var' => '', 'cms_url' => '', 'cms_urlvar' => '', 'cms_exts' => 'jpg,jpeg,gif,png', 'cms_col_content' => '[内容]', );